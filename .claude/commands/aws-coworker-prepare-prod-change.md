---
description: Translate an approved plan into CI/CD pipeline changes for production
skills: [aws-cli-playbook, aws-governance-guardrails, git-workflow]
agent: aws-coworker-executor
tools: [Read, Write, Edit, Bash]
arguments:
  - name: plan
    description: Reference to the approved plan
    required: true
  - name: iac-tool
    description: IaC tool to use (cdk, terraform, cloudformation)
    required: false
    default: cdk
---

# /aws-coworker-prepare-prod-change

## Overview

Translate an approved AWS interaction plan into Infrastructure as Code changes for production deployment via CI/CD pipeline. This command never directly executes changes against production.

## Prerequisites

- Approved plan from `/aws-coworker-plan-interaction`
- Git repository for infrastructure code
- Understanding of IaC patterns (CDK/Terraform/CloudFormation)

---

## Workflow

### Step 1: Load and Verify Plan

```
Loading plan: {plan reference}

Plan: {plan name}
Target: Production
Approval: {approved by user at timestamp}
Guardrail: {validation status}

Since this is a production change, I will:
1. Generate Infrastructure as Code
2. Create a Git branch
3. Prepare a PR with the changes
4. NOT execute any AWS commands directly
```

### Step 2: Analyze Plan for IaC Translation

Determine what needs to be codified:

```
## IaC Analysis

Plan components:
- {component 1}: {IaC approach}
- {component 2}: {IaC approach}
- {component 3}: {IaC approach}

Selected IaC tool: {cdk|terraform|cloudformation}

Files to create/modify:
- {file 1}
- {file 2}
```

### Step 3: Generate IaC Code

**For CDK (TypeScript):**

```typescript
// infrastructure/lib/{feature}-stack.ts

import * as cdk from 'aws-cdk-lib';
import * as ec2 from 'aws-cdk-lib/aws-ec2';
// ... other imports

export class {Feature}Stack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // Resources from plan
    // ...
  }
}
```

**For Terraform:**

```hcl
# infrastructure/terraform/{feature}/main.tf

resource "aws_instance" "example" {
  ami           = var.ami_id
  instance_type = var.instance_type

  tags = {
    Name        = "${var.environment}-${var.name}"
    Environment = var.environment
    Owner       = var.owner
    CostCenter  = var.cost_center
  }
}
```

**For CloudFormation:**

```yaml
# infrastructure/cloudformation/{feature}.yaml

AWSTemplateFormatVersion: '2010-09-09'
Description: {Description from plan}

Parameters:
  Environment:
    Type: String
    Default: production

Resources:
  # Resources from plan
```

### Step 4: Create Git Branch

```bash
# Create feature branch
git checkout -b feature/prod-{change-name}
```

```
Created branch: feature/prod-{change-name}
```

### Step 5: Write Files

Write the generated IaC files:

```
Writing files:
- infrastructure/{path}/{file1} ✅
- infrastructure/{path}/{file2} ✅
- infrastructure/{path}/{file3} ✅
```

### Step 6: Generate PR Description

Create comprehensive PR documentation:

```markdown
## Pull Request: {Change Title}

### Summary
{1-2 sentence summary of the change}

### Background
{Why this change is needed - from plan}

### Changes

#### Infrastructure Changes
- {Change 1}
- {Change 2}
- {Change 3}

#### Files Modified
- `infrastructure/{file1}` - {description}
- `infrastructure/{file2}` - {description}

### Well-Architected Assessment
| Pillar | Status | Notes |
|--------|--------|-------|
| Operational Excellence | ✅ | {notes} |
| Security | ✅ | {notes} |
| Reliability | ✅ | {notes} |
| Performance | ✅ | {notes} |
| Cost | ✅ | {notes} |
| Sustainability | ✅ | {notes} |

### Guardrail Validation
✅ All policies passed

### Rollback Plan
{Rollback procedure from plan}

### Testing
- [ ] Validated in staging environment
- [ ] IaC syntax validation passed
- [ ] Security review completed

### Change Management
- Change ticket: {ticket number if available}
- Deployment window: {suggested window}
- Rollback criteria: {criteria}

---
Generated by AWS Coworker
Original plan: {plan reference}
```

### Step 7: Commit and Prepare PR

```bash
# Stage files
git add infrastructure/

# Commit with comprehensive message
git commit -m "feat: {change title}

{detailed description}

Change-Id: {id}
Plan-Ref: {plan reference}

Co-Authored-By: AWS Coworker <aws-coworker@example.com>"
```

### Step 8: Present Next Steps

```
## Production Change Prepared

### Branch Created
`feature/prod-{change-name}`

### Files Generated
| File | Type | Purpose |
|------|------|---------|
| {file1} | {CDK/TF/CFN} | {purpose} |
| {file2} | {type} | {purpose} |

### Next Steps

1. **Review generated code:**
   ```bash
   git diff main..feature/prod-{change-name}
   ```

2. **Create Pull Request:**
   ```bash
   gh pr create --title "{title}" --body "$(cat .pr-description.md)"
   ```

3. **Complete PR checklist:**
   - [ ] Code review approved
   - [ ] Staging deployment validated
   - [ ] Change ticket linked
   - [ ] Deployment window scheduled

4. **After PR merge:**
   - CI/CD pipeline will deploy to production
   - Monitor deployment progress
   - Validate using production validation commands

### Validation Commands (post-deployment)
```bash
{validation commands from plan}
```

### Rollback (if needed)
```bash
# Option 1: Revert commit
git revert {commit-hash}

# Option 2: CDK/Terraform rollback
{tool-specific rollback}
```

---

⚠️ Remember: Do NOT manually apply these changes to production.
Let the CI/CD pipeline handle the deployment after PR approval.
```

---

## Output

The command produces:
1. **Git branch** with IaC changes
2. **Infrastructure code** (CDK/Terraform/CloudFormation)
3. **PR description** with full context
4. **Next steps guide** for completing the change

---

## Error Handling

### Missing IaC Repository

```
❌ Infrastructure repository not found

Expected: infrastructure/ directory
Found: {what was found}

Please ensure:
1. You're in the correct repository
2. Infrastructure directory exists
3. IaC tool is configured
```

### Unsupported Change

```
⚠️ This change may not be fully automatable

Components requiring manual handling:
- {component}

Recommendation:
- Generate partial IaC
- Document manual steps
- Include in PR description
```
